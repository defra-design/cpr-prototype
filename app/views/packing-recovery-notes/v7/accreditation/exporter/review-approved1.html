{% set serviceName = "Registration" %}

{% extends "layout.html" %}

{% block beforeContent %}
  {{ govukBackLink ({
      text: "Back",
      href: "javascript:history.back()"
  }) }}
{% endblock %}

{% block pageTitle %}
    {{serviceName}} prototype
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds-from-desktop">

    <h1 id="org-heading" class="govuk-heading-l">Interim sites used when exporting to ...</h1>

    <div class="govuk-inset-text">
      There is a charge per site. You must pay this after you've submitted your application.
      <br><br>
      <a href="interim-site-details" class="govuk-button">Add another interim site</a>
    </div>

    <div id="interim-site-list" class="govuk-body">
      <!-- JS will insert blocks here -->
    </div>

    <form method="post" novalidate>
      <button class="govuk-button" formaction="confirm-site2">Save and continue</button>
      <button class="govuk-button govuk-button--secondary" formaction="application-saved" style="margin-left: 20px;">Save and come back later</button>
    </form>
  </div>
</div>

<script>
function renderInterimSites() {
  const list = document.getElementById("interim-site-list");
  list.innerHTML = "";
  const sites = JSON.parse(localStorage.getItem("interimSites") || "[]");

  if (!sites.length) {
    list.innerHTML = `<p class="govuk-body">No interim sites added yet.</p>`;
    return;
  }

  sites.forEach((site, index) => {
    const orgName = site.orgName || '-';
    const countryName = site.country || '-';
    const address = [
      site.addressLine1,
      site.addressLine2,
      site.addressTown,
      site.addressPostcode,
      site.coordinates
    ].filter(Boolean).join('<br>');

    const contactDetails = [
      site.contactName,
      site.email,
      site.phone
    ].filter(Boolean).join('<br>');

    const wasteCode = site.wasteCode || '';

    const block = `
      <div class="govuk-!-margin-bottom-6">
        <div class="govuk-grid-row">
          <div class="govuk-grid-column-one-third">
            <strong class="govuk-body">Organisation details ${index + 1}</strong>
          </div>
          <div class="govuk-grid-column-one-third">
            ${orgName}<br>${address} <br>${countryName}
          </div>
          <div class="govuk-grid-column-one-third govuk-!-text-align-right">
            <a href="javascript:void(0)" class="govuk-link" onclick="removeInterimSite(${index})">Remove</a> |
            <a href="interim-site-details?editIndex=${index}&redirect=review-approved1" class="govuk-link">Change</a>

          </div>
        </div>

        <div class="govuk-grid-row govuk-!-margin-top-2">
          <div class="govuk-grid-column-one-third">
            <strong class="govuk-body">Contact details</strong>
          </div>
          <div class="govuk-grid-column-two-thirds">
            ${contactDetails}
          </div>
        </div>

        ${wasteCode ? `
        <div class="govuk-grid-row govuk-!-margin-top-2">
          <div class="govuk-grid-column-one-third">
            <strong class="govuk-body">Basel Convention and OECD codes</strong>
          </div>
          <div class="govuk-grid-column-two-thirds">
            ${wasteCode} <a href="basel-convention-oecd-code?index=${index}&redirect=check-answers7" class="govuk-link">Change</a>
          </div>
        </div>` : ''}

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
      </div>
    `;

    list.insertAdjacentHTML('beforeend', block);
  });
}

function removeInterimSite(index) {
  let sites = JSON.parse(localStorage.getItem("interimSites") || "[]");
  if (sites.length > index) {
    sites.splice(index, 1);
    localStorage.setItem("interimSites", JSON.stringify(sites));
    renderInterimSites();
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const orgName = localStorage.getItem("latestInterimOrgName") || "the selected organisation";
  document.getElementById("org-heading").textContent = `Interim sites used when exporting to ${orgName}`;
  renderInterimSites();
});
</script>
{% endblock %}
